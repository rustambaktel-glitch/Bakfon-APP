<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <title>Kassa Sistemi (Realtime)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; }
    h2 { background: red; color: #fff; padding: 10px; border-radius: 8px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #555; padding: 6px; text-align: center; }
    th { background: #f5f5f5; }
    input[type="text"] { width: 160px; padding: 6px; }
    input[type="number"] { width: 110px; padding: 6px; text-align: right; }
    button { padding: 6px 12px; margin: 6px 0; }
    tfoot .balans { background: #4CAF50; color: white; font-weight: bold; font-size: 20px; }
    .row-actions button { padding: 4px 10px; }
  </style>
</head>
<body>
  <h2>Kassa Hesabatƒ± (Firebase Realtime)</h2>

  <table id="tbl">
    <thead>
      <tr>
        <th>Hesab</th>
        <th>1</th>
        <th>2</th>
        <th>3</th>
        <th>4</th>
        <th>5</th>
        <th>∆èm…ôliyyat</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
    <tfoot>
      <tr class="balans">
        <td colspan="7">Balans: <span id="balans">0</span></td>
      </tr>
    </tfoot>
  </table>

  <button id="addRowBtn">+ S…ôtir …ôlav…ô et</button>

  <!-- Firebase SDK (modular v9) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getFirestore, collection, addDoc, updateDoc, deleteDoc,
      onSnapshot, doc, serverTimestamp, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
    import {
      getAuth, signInAnonymously
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    // üîß 1) BURAYA √ñZ FIREBASE CONFIG-ƒ∞Nƒ∞ YAPI≈ûDIR
    // üîß 1) BURAYA √ñZ FIREBASE CONFIG-ƒ∞Nƒ∞ YAPI≈ûDIR
const firebaseConfig = {
  apiKey: "AIzaSyAsFuSc8V8vnWzahq8HwJpGYG7p_kApISw",
  authDomain: "bakfon-kassa.firebaseapp.com",
  projectId: "bakfon-kassa",
  storageBucket: "bakfon-kassa.appspot.com",
  messagingSenderId: "804463176964",
  appId: "1:804463176964:web:xxxxxx"
};


    // üîß 2) Firebase init
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    await signInAnonymously(auth); // H…ôr k…ôs yazƒ±b-oxuya bilsin dey…ô (sonra qaydalarƒ± s…ôrtl…ô≈üdir…ôrik)

    // üîß 3) Kolleksiya
    const rowsCol = collection(db, "rows");

    const tbodyEl = document.getElementById("tbody");
    const balansEl = document.getElementById("balans");
    const addRowBtn = document.getElementById("addRowBtn");

    // Realtime dinl…ôm…ô (b√ºt√ºn istifad…ô√ßil…ôr…ô canlƒ± yenil…ônir)
    const q = query(rowsCol, orderBy("createdAt", "asc"));
    onSnapshot(q, (snap) => {
      // C…ôdv…ôli sƒ±fƒ±rla v…ô yenid…ôn qur
      tbodyEl.innerHTML = "";
      let total = 0;

      snap.forEach((d) => {
        const row = d.data();
        const id = d.id;

        // DOM s…ôtirini yarad
        const tr = document.createElement("tr");

        // Hesab adƒ±
        const tdAcc = document.createElement("td");
        const inpAcc = document.createElement("input");
        inpAcc.type = "text";
        inpAcc.placeholder = "Hesab adƒ±";
        inpAcc.value = row.account || "";
        inpAcc.onchange = () => updateDoc(doc(db, "rows", id), { account: inpAcc.value ?? "" });
        tdAcc.appendChild(inpAcc);
        tr.appendChild(tdAcc);

        // 1..5 r…ôq…ôm s√ºtunlarƒ±
        const numberInputs = [];
        for (let i = 1; i <= 5; i++) {
          const td = document.createElement("td");
          const inp = document.createElement("input");
          inp.type = "number";
          if (row["n" + i] === null || row["n" + i] === undefined) {
            inp.value = "";
          } else {
            inp.value = row["n" + i];
          }

          // Balans h…ôr d…ôyi≈üiklikd…ô toplansƒ±n (ist…ônil…ôn xanaya yazƒ±landa)
          inp.onchange = () => {
            // Sad…ô yazma: bo≈üdursa null, doludursa number
            const val = inp.value === "" ? null : Number(inp.value);
            updateDoc(doc(db, "rows", id), { ["n" + i]: val });
          };

          td.appendChild(inp);
          tr.appendChild(td);
          numberInputs.push(inp);

          // Balans hesabƒ± (b√ºt√ºn xanalardakƒ± r…ôq…ôml…ôri toplayƒ±rƒ±q)
          const v = Number(inp.value) || 0;
          total += v;
        }

        // ∆èm…ôliyyat (Sil) + 5-ci s√ºtun √º√ß√ºn s…ôtrin c…ômi m…ôntiqi
        const tdOps = document.createElement("td");
        tdOps.className = "row-actions";

        const btnDel = document.createElement("button");
        btnDel.textContent = "Sil";
        btnDel.onclick = async () => {
          await deleteDoc(doc(db, "rows", id));
        };

        tdOps.appendChild(btnDel);
        tr.appendChild(tdOps);

        // 5-ci s√ºtun dolanda: s…ôtrin c…ômi ‚Üí 1-ci r…ôq…ôm s√ºtununa, dig…ôrl…ôri bo≈ü
        numberInputs[4].onchange = async () => {
          const lastVal = numberInputs[4].value;
          if (lastVal !== "") {
            let sum = 0;
            for (let i = 0; i < 5; i++) sum += Number(numberInputs[i].value) || 0;

            await updateDoc(doc(db, "rows", id), {
              n1: sum,
              n2: null,
              n3: null,
              n4: null,
              n5: null
            });
          } else {
            // 5-ci xana bo≈üaldƒ±larsa, sad…ôc…ô d…ôy…ôrini null et
            await updateDoc(doc(db, "rows", id), { n5: null });
          }
        };

        tbodyEl.appendChild(tr);
      });

      // Alt hiss…ôd…ô Balans (b√ºt√ºn xanalardakƒ± m…ôbl…ôƒül…ôrin c…ômi)
      balansEl.textContent = total;
    });

    // Yeni s…ôtir …ôlav…ô et
    addRowBtn.onclick = async () => {
      await addDoc(rowsCol, {
        account: "",
        n1: null,
        n2: null,
        n3: null,
        n4: null,
        n5: null,
        createdAt: serverTimestamp()
      });
    };
  </script>
</body>
</html>
